<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:xmlns="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{admin/layout-page-admin}">

</html>

<head>
    <title>add-product</title>

</head>

<body>
    <div class="app">
        <div layout:fragment="content" class="content d-flex justify-content-center">
            <form action="#" th:action="@{/admin/products/add}"
                class="form w-75 mt-5 d-flex flex-column justify-content-center align-items-center" method="post"
                enctype="multipart/form-data" th:object="${product}">
                <div class="row justify-content-center">
                    <div class="col col-8 overflow-hidden">
                        <div>
                            <i class="alert-error text-danger" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">
                            </i>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Tên xe</span>
                            <input class="form-control" type="text" placeholder="Tên xe" name="name" id="name"
                                th:field="*{name}">
                            
                        </div>
                        <div class="row mb-2">
                            <div class="input-group col">
                                <span class="input-group-text">Chiều Dài(mm)</span>
                                <input class="form-control" type="number" name="chieuDai" id="chieuDai"
                                    th:field="*{length}">
                            </div>
                            <div class="input-group col">
                                <span class="input-group-text">Chiều rộng(mm)</span>
                                <input class="form-control" type="number" name="chieuRong" id="chieuRong"
                                    th:field="*{width}">
                            </div>
                            <div class="input-group col">
                                <span class="input-group-text">Chiều cao(mm)</span>
                                <input class="form-control" type="number" name="chieuCao" id="chieuCao"
                                    th:field="*{height}">
                            </div>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Trọng lượng(kg)</span>
                            <input class="form-control" type="number" name="" id="" th:field="*{weight}">
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Tải trọng(kg)</span>
                            <input class="form-control" type="number" name="" id="" th:field="*{maximumLoad}">
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Acquy</span>
                            <input class="form-control" type="number" name="" id="" th:field="*{battery}">
                        </div>
                        <div class="row mb-2">
                            <div class="input-group col">
                                <span class="input-group-text">Thời gian sạc: </span>
                            </div>
                            <div class="input-group col">
                                <span class="input-group-text">từ </span>
                                <input class="form-control" type="number" name="thoiGianSacMin" id="thoiGianSacMin"
                                    th:field="*{minimumChargingTime}">
                            </div>
                            <div class="input-group col">
                                <span class="input-group-text">đến</span>
                                <input class="form-control" type="number" name="thoiGianSacMax" id="thoiGianSacMax"
                                    th:field="*{maximumChargingTime}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="input-group col">
                                <span class="input-group-text">Vận tốc xe (km/h): </span>
                            </div>
                            <div class="input-group col">
                                <span class="input-group-text">từ</span>
                                <input class="form-control" type="number" name="" id=""
                                    th:field="*{minimumMaximumSpeed}">
                            </div>
                            <div class="input-group col">
                                <span class="input-group-text">đến</span>
                                <input class="form-control" type="number" name="" id=""
                                    th:field="*{maximumMaximumSpeed}">
                            </div>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Quảng đường đi được (km)</span>
                            <div class="input-group col">
                                <span class="input-group-text">từ</span>
                                <input class="form-control" type="number" name="" id="" th:field="*{distanceMin}">
                            </div>
                            <div class="input-group col">
                                <span class="input-group-text">đến</span>
                                <input class="form-control" type="number" name="" id="" th:field="*{distanceMax}">
                            </div>
                        </div>

                        <div class="alert-error  text-danger" th:if="${#fields.hasErrors('manufacturerId')}"
                            th:errors="*{manufacturerId}">
                        </div>
                        <select class="form-select mb-2" th:field="*{manufacturerId}">
                            <option value="0" selected>Nhà sản xuất</option>
                            <option th:if="${manufacturers}" th:each="manufacturer : ${manufacturers}"
                                th:value="${manufacturer.id}" th:text="${manufacturer.name}"></option>
                        </select>

                        <div class="alert-error  text-danger" th:if="${#fields.hasErrors('catergoryId')}"
                            th:errors="*{catergoryId}">
                        </div>
                        <select class="form-select mb-2" th:field="*{catergoryId}">
                            <option value="0" selected>Loại</option>
                            <option th:if="${catergories}" th:each="catergory : ${catergories}"
                                th:value="${catergory.id}" th:text="${catergory.name}"></option>
                        </select>

                        <div>
                            <button id="addRow">+</button>
                            <table class="table table-bordered ">
                                <thead>
                                    <tr>
                                        <th class="col">Màu</th>
                                        <th class="col">Giá</th>
                                        <th class="col">Số lượng</th>
                                        <th class="col">SKU</th>
                                        <th class="col">Ảnh</th>
                                        <th class="col">Option</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    <tr th:each="optionRequest, itemStat : *{optionRequests}" class="table-row"
                                        onclick="tableRowHandler(this)">
                                        <td>
                                            <input required oninput="setCustomValidity('')"
                                                oninvalid="this.setCustomValidity('Màu không được để trống')"
                                                th:field="*{optionRequests[__${itemStat.index}__].color}" type="text"
                                                class="input-table">
                                        </td>
                                        <td>
                                            <input th:field="*{optionRequests[__${itemStat.index}__].price}"
                                                type="number" step="0.1" min="1" class="input-table">
                                        </td>
                                        <td>
                                            <input th:field="*{optionRequests[__${itemStat.index}__].quantity}"
                                                type="number" min="1" class="input-table">
                                        </td>
                                        <td>
                                            <input oninput="setCustomValidity('')"
                                                oninvalid="this.setCustomValidity('Cần có SKU')" required
                                                th:field="*{optionRequests[__${itemStat.index}__].sku}" type="text"
                                                class="input-table">
                                        </td>
                                        <td>
                                            <input oninput="setCustomValidity('')"
                                                oninvalid="this.setCustomValidity('Vui lòng chọn ảnh sản phẩm')"
                                                required th:field="*{optionRequests[__${itemStat.index}__].imageFile}"
                                                type="file" class="imageFile" name="imageFile" id="imageFile">
                                        </td>
                                        <td>
                                            <button class="btnRemoveRow">X</button>
                                        </td>
                                    </tr>



                                </tbody>

                            </table>
                        </div>

                    </div>
                    <div class="col col-4 row flex-column align-items-center justify-content-center">
                        <div class="wrap-image d-flex justify-content-center mb-3">
                            <img id="image" src="" th:src="@{/image/default-image.jpg}" alt=""
                                class="rounded product-image w-75">
                        </div>
                    </div>
                </div>

                <div class="w-50 align-self-center">
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </div>
            </form>
        </div>
    </div>
    <script>

        var btnAddRow = document.querySelector("#addRow");
        var tableBody = document.querySelector("#table-body");


        function loadList(nodeRoot, rows) {
            rows.forEach(element => {
                nodeRoot.appendChild(element);
            });
        }

        btnAddRow.addEventListener("click", function (e) {
            e.preventDefault();
            var rows = document.querySelectorAll(".table-row");
            console.log(rows.length);
            tableBody.innerHTML = '';

            var tr = document.createElement("tr");

            tr.classList.add("table-row");
            var i = rows.length++;
            tr.innerHTML = `
                <td>
                    <input required  oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('Màu không được để trống')" id="optionRequests${i}.color" name="optionRequests[${i}].color" type="text" class="input-table">
                </td>
                <td>
                    <input name="optionRequests[${i}].price" type="number" step="0.1" min="1" class="input-table">
                </td>
                <td>
                    <input name="optionRequests[${i}].quantity"  type="number"  min="1" class="input-table">
                </td>
                <td>
                    <input required oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('Cần có SKU')" name="optionRequests[${i}].sku" type="text" class="input-table">
                    
                </td>
                <td>
                    <input oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('Vui lòng chọn ảnh sản phẩm')" required name="optionRequests[${i}].imageFile" type="file" class="imageFile" name="imageFile" id="imageFile">
                </td>
                <td>
                    <button class="btnRemoveRow">X</button>
                </td>
            `;
            tr.addEventListener("click", function (tr) {
                var fr = new FileReader();
                fr.onload = function () {
                    document.getElementById("image").src = fr.result;
                }
                var parentElement = tr.target.parentElement;
                if (parentElement.tagName === 'TD')
                    parentElement = parentElement.parentElement;

                var file = parentElement.querySelector(".imageFile").files[0];
                if (file)
                    fr.readAsDataURL(file);
            });

            console.log(tr);
            rows = [...rows, tr]
            loadList(tableBody, rows);

            removeRowHandler();
            eventListBtnImage();
            console.log(rows);
        });



        function removeRowHandler() {
            var btnRemoveRows = document.querySelectorAll(".btnRemoveRow");
            if (btnRemoveRows.length != 1)
                btnRemoveRows.forEach(element => {
                    element.addEventListener("click", function (e) {
                        e.preventDefault();
                        if (e.target.parentElement.parentElement.tagName === 'TR')
                            tableBody.removeChild(e.target.parentElement.parentElement)
                    });
                });
        }
        removeRowHandler();

        var tableRowHandler = function (e) {

            var fr = new FileReader();
            fr.onload = function () {
                document.getElementById("image").src = fr.result;
            }
            if (e.querySelector(".imageFile").files[0])
                fr.readAsDataURL((e.querySelector(".imageFile").files[0]));
        }

        var eventListBtnImage = function () {
            var imageButtons = document.querySelectorAll(".imageFile");
            for (var i = 0; i < imageButtons.length; i++) {
                imageButtons[i].onchange = function (evt) {
                    var tgt = evt.target || window.event.srcElement,
                        files = tgt.files;

                    // FileReader support
                    if (FileReader && files && files.length) {
                        var fr = new FileReader();

                        fr.onload = function () {
                            document.getElementById("image").src = fr.result;
                        }
                        fr.readAsDataURL(files[0]);
                    }
                }
            }
        }

        eventListBtnImage();
    </script>
</body>

</html>